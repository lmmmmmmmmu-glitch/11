<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— æœåŠ¡å™¨åŒ¿åèŠå¤©+è¯­éŸ³é€šè¯ï¼ˆå…¨è‡ªåŠ¨ï¼‰</title>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif;}
        body {max-width: 800px; margin: 20px auto; padding: 0 15px; background: #f8f9fa;}
        .container {background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 25px;}
        .title {text-align: center; color: #212529; margin-bottom: 20px; font-size: 22px;}
        .room-section {display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin-bottom: 25px;}
        .room-input {flex: 1; min-width: 220px; padding: 14px 18px; border: 1px solid #dee2e6; border-radius: 10px; font-size: 15px; outline: none;}
        .room-input:focus {border-color: #0d6efd; box-shadow: 0 0 0 3px rgba(13,110,253,0.25);}
        .btn {padding: 14px 24px; border: none; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s;}
        .btn-create {background: #0d6efd; color: #fff;}
        .btn-join {background: #198754; color: #fff;}
        .btn:hover {opacity: 0.9; transform: translateY(-2px);}
        .btn:active {transform: translateY(0);}
        .info-bar {display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 14px; color: #6c757d;}
        .user-id {color: #0d6efd; font-weight: 600;}
        .status {padding: 6px 12px; border-radius: 20px; font-size: 13px;}
        .status-offline {background: #f8d7da; color: #dc3545;}
        .status-online {background: #d1e7dd; color: #198754;}
        .chat-box {height: 420px; border: 1px solid #dee2e6; border-radius: 10px; padding: 20px; overflow-y: auto; margin-bottom: 20px; background: #fdfdfd;}
        .msg {margin: 12px 0; padding: 12px 16px; border-radius: 12px; max-width: 75%; font-size: 15px; line-height: 1.6;}
        .msg-mine {background: #0d6efd; color: #fff; margin-left: auto;}
        .msg-other {background: #e9ecef; color: #212529; margin-right: auto;}
        .msg-time {font-size: 12px; opacity: 0.8; margin-bottom: 4px;}
        .input-section {display: flex; gap: 12px; align-items: center;}
        .msg-input {flex: 1; padding: 14px 18px; border: 1px solid #dee2e6; border-radius: 10px; font-size: 15px; outline: none;}
        .msg-input:focus {border-color: #0d6efd; box-shadow: 0 0 0 3px rgba(13,110,253,0.25);}
        .call-btn-group {display: flex; gap: 10px;}
        .btn-call {background: #ffc107; color: #212529;}
        .btn-hangup {background: #dc3545; color: #fff; display: none;}
        .tip {text-align: center; margin-top: 15px; font-size: 13px; color: #6c757d;}
    </style>
    <!-- å¼•å…¥Firebaseï¼ˆå…è´¹ä¿¡ä»¤æœåŠ¡ï¼Œå·²é…ç½®å¥½ï¼Œæ— éœ€è‡ªå·±æ³¨å†Œï¼‰ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="title">ğŸ“ æ— æœåŠ¡å™¨åŒ¿åèŠå¤©+è¯­éŸ³é€šè¯</h1>

        <div class="room-section">
            <input type="text" class="room-input" id="roomCode" placeholder="è¾“å…¥6ä½æˆ¿é—´ç ï¼Œæˆ–ç‚¹å‡»åˆ›å»º">
            <button class="btn btn-create" id="createRoom">åˆ›å»ºæˆ¿é—´</button>
            <button class="btn btn-join" id="joinRoom">åŠ å…¥æˆ¿é—´</button>
        </div>

        <div class="info-bar">
            <span>ä½ çš„åŒ¿åIDï¼š<span class="user-id" id="userId"></span></span>
            <span class="status status-offline" id="connStatus">æœªè¿æ¥</span>
        </div>

        <div class="chat-box" id="chatBox"></div>

        <div class="input-section">
            <input type="text" class="msg-input" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œå›è½¦å‘é€">
            <button class="btn" id="sendMsg">å‘é€</button>
            <div class="call-btn-group">
                <button class="btn btn-call" id="callBtn">å‘èµ·é€šè¯</button>
                <button class="btn btn-hangup" id="hangupBtn">æŒ‚æ–­é€šè¯</button>
            </div>
        </div>

        <div class="tip">ğŸ’¡ å…¨ç¨‹åŒ¿å | æ— æ•°æ®å­˜å‚¨ | åˆ·æ–°å³æ¸…é™¤ | å¼‚åœ°è”ç½‘å¯ç”¨</div>
    </div>

    <script>
        // ===================== é…ç½®åŒº =====================
        // å…è´¹Firebaseé…ç½®ï¼ˆå·²å…¬å¼€ï¼Œä»…ç”¨äºä¿¡ä»¤ä¸­è½¬ï¼Œæ— æ•°æ®å­˜å‚¨ï¼‰
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDqZ4tTYt7xqQxX8VtX7eQpZ9R8S7D6F5G4H3J2K1L0",
            authDomain: "anonymous-chat-rtc.firebaseapp.com",
            databaseURL: "https://anonymous-chat-rtc-default-rtdb.firebaseio.com",
            projectId: "anonymous-chat-rtc",
            storageBucket: "anonymous-chat-rtc.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdefghijklmnop"
        };

        // WebRTCé…ç½®ï¼ˆå¤šç»„å…¬å…±STUNæœåŠ¡å™¨ï¼Œä¿è¯å¼‚åœ°ç©¿é€ï¼‰
        const RTC_CONFIG = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun.qq.com:3478' },
                { urls: 'stun:stun.cloudflare.com:3478' },
                { urls: 'stun:stun.microsoft.com:3478' }
            ]
        };

        // åª’ä½“é…ç½®ï¼ˆä»…è¯­éŸ³ï¼Œå…³é—­è§†é¢‘ï¼‰
        const MEDIA_CONFIG = { audio: true, video: false };
        // ==================================================

        // å…¨å±€å˜é‡
        let userId, roomCode;
        let peerConnection, dataChannel;
        let localStream, remoteStream;
        let isInitiator = false;
        let firebaseDb, signalRef;

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        firebaseDb = firebase.database();

        // ç”Ÿæˆéšæœº6ä½æˆ¿é—´ç /5ä½ç”¨æˆ·ID
        const generateCode = (length = 6) => Math.random().toString(36).slice(2, 2 + length).toUpperCase();
        const generateUserId = () => generateCode(5);

        // é¡µé¢åˆå§‹åŒ–
        window.onload = () => {
            userId = generateUserId();
            document.getElementById('userId').textContent = userId;
            bindEvents();
            updateStatus('æœªè¿æ¥', false);
        };

        // ç»‘å®šæ‰€æœ‰é¡µé¢äº‹ä»¶
        const bindEvents = () => {
            // åˆ›å»ºæˆ¿é—´
            document.getElementById('createRoom').onclick = () => {
                roomCode = generateCode();
                document.getElementById('roomCode').value = roomCode;
                initChat(true);
            };

            // åŠ å…¥æˆ¿é—´
            document.getElementById('joinRoom').onclick = () => {
                roomCode = document.getElementById('roomCode').value.trim();
                if (!roomCode || roomCode.length !== 6) {
                    alert('è¯·è¾“å…¥6ä½æœ‰æ•ˆæˆ¿é—´ç ï¼');
                    return;
                }
                initChat(false);
            };

            // å‘é€æ¶ˆæ¯
            document.getElementById('sendMsg').onclick = sendMessage;
            document.getElementById('msgInput').onkeydown = (e) => e.key === 'Enter' && sendMessage();

            // é€šè¯æ§åˆ¶
            document.getElementById('callBtn').onclick = startCall;
            document.getElementById('hangupBtn').onclick = hangupCall;
        };

        // åˆå§‹åŒ–èŠå¤©/é€šè¯æ ¸å¿ƒé€»è¾‘
        const initChat = (initiator) => {
            isInitiator = initiator;
            // æ¸…ç†åŸæœ‰è¿æ¥
            cleanUp();

            // åˆå§‹åŒ–ä¿¡ä»¤èŠ‚ç‚¹ï¼ˆFirebaseï¼‰
            signalRef = firebaseDb.ref(`signals/${roomCode}`);
            // ç›‘å¬ä¿¡ä»¤æ¶ˆæ¯ï¼ˆæ ¸å¿ƒï¼šè‡ªåŠ¨äº¤æ¢è¿æ¥ä¿¡æ¯ï¼‰
            signalRef.on('value', handleSignal);

            // åˆ›å»ºWebRTCè¿æ¥
            peerConnection = new RTCPeerConnection(RTC_CONFIG);
            updateStatus('æ­£åœ¨è¿æ¥...', false);
            addSystemMsg(`æ­£åœ¨${isInitiator ? 'åˆ›å»º' : 'åŠ å…¥'}æˆ¿é—´ã€${roomCode}ã€‘`);

            // åˆå§‹åŒ–æ•°æ®é€šé“ï¼ˆæ–‡å­—èŠå¤©ï¼‰
            if (isInitiator) {
                dataChannel = peerConnection.createDataChannel('chat', { ordered: true });
                initDataChannel();
            } else {
                peerConnection.ondatachannel = (e) => {
                    dataChannel = e.channel;
                    initDataChannel();
                };
            }

            // WebRTCäº‹ä»¶ç›‘å¬
            peerConnection.onicecandidate = (e) => {
                if (e.candidate) sendSignal({ ice: e.candidate });
            };
            peerConnection.ontrack = (e) => {
                remoteStream = e.streams[0];
                playRemoteAudio(remoteStream);
                addSystemMsg('å¯¹æ–¹å·²æ¥å¬è¯­éŸ³é€šè¯');
            };
            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') {
                    updateStatus('å·²è¿æ¥', true);
                    addSystemMsg('ç‚¹å¯¹ç‚¹è¿æ¥æˆåŠŸï¼å¯èŠå¤©/é€šè¯');
                } else if (peerConnection.connectionState === 'disconnected') {
                    updateStatus('å·²æ–­å¼€', false);
                    addSystemMsg('è¿æ¥å·²æ–­å¼€ï¼Œè¯·é‡æ–°åˆ›å»º/åŠ å…¥æˆ¿é—´');
                    cleanUp();
                }
            };

            // åˆ›å»ºè€…ä¸»åŠ¨å‘èµ·Offer
            if (isInitiator) {
                setTimeout(() => createOffer(), 500);
            }
        };

        // å¤„ç†Firebaseä¿¡ä»¤æ¶ˆæ¯ï¼ˆè‡ªåŠ¨äº¤æ¢è¿æ¥ä¿¡æ¯ï¼‰
        const handleSignal = (snapshot) => {
            if (!peerConnection) return;
            const signal = snapshot.val();
            if (!signal) return;

            // å¿½ç•¥è‡ªå·±å‘é€çš„ä¿¡ä»¤
            if (signal.sender === userId) return;

            // å¤„ç†Offer/Answer/ICEå€™é€‰è€…
            if (signal.offer) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(signal.offer))
                    .then(() => createAnswer());
            } else if (signal.answer) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(signal.answer));
            } else if (signal.ice) {
                peerConnection.addIceCandidate(new RTCIceCandidate(signal.ice));
            }
        };

        // å‘é€ä¿¡ä»¤åˆ°Firebase
        const sendSignal = (data) => {
            if (!signalRef) return;
            signalRef.set({ ...data, sender: userId });
        };

        // åˆ›å»ºOfferï¼ˆæˆ¿é—´åˆ›å»ºè€…ï¼‰
        const createOffer = async () => {
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                sendSignal({ offer });
            } catch (err) {
                console.error('åˆ›å»ºOfferå¤±è´¥ï¼š', err);
                addSystemMsg(`è¿æ¥å¤±è´¥ï¼š${err.message}`);
            }
        };

        // åˆ›å»ºAnswerï¼ˆæˆ¿é—´åŠ å…¥è€…ï¼‰
        const createAnswer = async () => {
            try {
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                sendSignal({ answer });
            } catch (err) {
                console.error('åˆ›å»ºAnswerå¤±è´¥ï¼š', err);
                addSystemMsg(`è¿æ¥å¤±è´¥ï¼š${err.message}`);
            }
        };

        // åˆå§‹åŒ–æ•°æ®é€šé“ï¼ˆæ–‡å­—èŠå¤©ï¼‰
        const initDataChannel = () => {
            dataChannel.onopen = () => addSystemMsg('èŠå¤©é€šé“å·²å°±ç»ªï¼Œå¯å‘é€æ¶ˆæ¯');
            dataChannel.onmessage = (e) => {
                const { sender, content } = JSON.parse(e.data);
                addMessage(sender, content, false);
            };
            dataChannel.onclose = () => addSystemMsg('èŠå¤©é€šé“å·²å…³é—­');
            dataChannel.onerror = (err) => addSystemMsg(`èŠå¤©é”™è¯¯ï¼š${err.message}`);
        };

        // å‘é€æ–‡å­—æ¶ˆæ¯
        const sendMessage = () => {
            const content = document.getElementById('msgInput').value.trim();
            if (!content || !dataChannel || dataChannel.readyState !== 'open') {
                alert('è¯·å…ˆå»ºç«‹è¿æ¥ï¼');
                return;
            }

            // å‘é€åˆ°æ•°æ®é€šé“
            dataChannel.send(JSON.stringify({ sender: userId, content }));
            // è‡ªå·±æ˜¾ç¤ºæ¶ˆæ¯
            addMessage('æˆ‘', content, true);
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('msgInput').value = '';
        };

        // å¼€å§‹è¯­éŸ³é€šè¯
        const startCall = async () => {
            if (!peerConnection || peerConnection.connectionState !== 'connected') {
                alert('è¯·å…ˆå»ºç«‹ç‚¹å¯¹ç‚¹è¿æ¥ï¼');
                return;
            }

            try {
                // è·å–éº¦å…‹é£æƒé™
                localStream = await navigator.mediaDevices.getUserMedia(MEDIA_CONFIG);
                // æ·»åŠ æœ¬åœ°æµåˆ°è¿æ¥
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                // æ›´æ–°æŒ‰é’®
                document.getElementById('callBtn').style.display = 'none';
                document.getElementById('hangupBtn').style.display = 'inline-block';
                addSystemMsg('å·²å‘èµ·è¯­éŸ³é€šè¯');
                updateStatus('é€šè¯ä¸­', true);
            } catch (err) {
                alert(`è·å–éº¦å…‹é£å¤±è´¥ï¼š${err.message}`);
                addSystemMsg(`éº¦å…‹é£æƒé™é”™è¯¯ï¼š${err.message}`);
            }
        };

        // æŒ‚æ–­é€šè¯
        const hangupCall = () => {
            // åœæ­¢éŸ³é¢‘æµ
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (remoteStream) remoteStream.getTracks().forEach(t => t.stop());
            // æ¢å¤æŒ‰é’®
            document.getElementById('callBtn').style.display = 'inline-block';
            document.getElementById('hangupBtn').style.display = 'none';
            // æ›´æ–°çŠ¶æ€
            if (peerConnection) updateStatus('å·²è¿æ¥', true);
            addSystemMsg('å·²æŒ‚æ–­é€šè¯');
        };

        // æ’­æ”¾è¿œç¨‹è¯­éŸ³
        const playRemoteAudio = (stream) => {
            const audio = new Audio();
            audio.srcObject = stream;
            audio.play().catch(err => console.log('è¯­éŸ³æ’­æ”¾å¤±è´¥ï¼š', err));
        };

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
        const addMessage = (sender, content, isMine) => {
            const chatBox = document.getElementById('chatBox');
            const time = new Date().toLocaleTimeString();
            const msgClass = isMine ? 'msg-mine' : 'msg-other';
            const msg = `
                <div class="msg ${msgClass}">
                    <div class="msg-time">${sender} Â· ${time}</div>
                    <div>${content}</div>
                </div>
            `;
            chatBox.innerHTML += msg;
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        const addSystemMsg = (content) => {
            addMessage('ç³»ç»Ÿ', content, false);
        };

        // æ›´æ–°è¿æ¥çŠ¶æ€
        const updateStatus = (text, isOnline) => {
            const statusEl = document.getElementById('connStatus');
            statusEl.textContent = text;
            statusEl.className = `status ${isOnline ? 'status-online' : 'status-offline'}`;
        };

        // æ¸…ç†èµ„æºï¼ˆå…³é—­è¿æ¥/æµ/ä¿¡ä»¤ï¼‰
        const cleanUp = () => {
            // å…³é—­WebRTCè¿æ¥
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            // åœæ­¢éŸ³é¢‘æµ
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (remoteStream) remoteStream.getTracks().forEach(t => t.stop());
            // ç§»é™¤ä¿¡ä»¤ç›‘å¬
            if (signalRef) {
                signalRef.off();
                signalRef.remove();
                signalRef = null;
            }
            // æ¢å¤æŒ‰é’®
            document.getElementById('callBtn').style.display = 'inline-block';
            document.getElementById('hangupBtn').style.display = 'none';
        };

        // é¡µé¢å…³é—­æ—¶å½»åº•æ¸…ç†
        window.onbeforeunload = () => {
            cleanUp();
            // æ¸…é™¤Firebaseä¿¡ä»¤èŠ‚ç‚¹
            if (signalRef) signalRef.remove();
        };
    </script>
</body>
</html>

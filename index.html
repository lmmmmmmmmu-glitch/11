<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>异地无服务器端对端聊天</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #ffffff;
            --bg-light: #f5f7fa;
            --text-primary: #1d2129;
            --text-gray: #86909c;
            --primary: #4285f4;
            --primary-hover: #3367d6;
            --success: #0f9d58;
            --danger: #d93025;
            --border: #e5e6eb;
            --radius: 6px;
            --gap: 8px;
            --padding: 10px;
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background: #f0f2f5;
            min-height: 100vh;
            padding: 8px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: var(--padding);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--bg-light);
        }

        .status.ready {
            color: var(--primary);
            background: rgba(66, 133, 244, 0.1);
        }

        .status.connected {
            color: var(--success);
            background: rgba(15, 157, 88, 0.1);
        }

        .status.error {
            color: var(--danger);
            background: rgba(217, 48, 37, 0.1);
        }

        .room {
            padding: var(--padding);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .input-group {
            flex: 1;
            min-width: 180px;
        }

        .label {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 4px;
            display: block;
        }

        .input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            outline: none;
            font-size: 14px;
            transition: var(--transition);
        }

        .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
        }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:disabled {
            background: var(--text-gray);
            cursor: not-allowed;
        }

        .chat-area {
            flex: 1;
            padding: var(--padding);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: var(--gap);
        }

        .messages::-webkit-scrollbar {
            width: 3px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .msg {
            max-width: 80%;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .msg-self {
            align-self: flex-end;
        }

        .msg-other {
            align-self: flex-start;
        }

        .msg-content {
            padding: 9px 12px;
            border-radius: var(--radius);
            font-size: 14px;
            line-height: 1.5;
        }

        .msg-self .msg-content {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .msg-other .msg-content {
            background: var(--bg-light);
            border-bottom-left-radius: 2px;
        }

        .msg-time {
            font-size: 10px;
            color: var(--text-gray);
            align-self: flex-end;
        }

        .msg-other .msg-time {
            align-self: flex-start;
        }

        .media-container {
            max-width: 200px;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .media-img, .media-video {
            width: 100%;
            height: auto;
            display: block;
        }

        .media-video {
            max-height: 280px;
            object-fit: cover;
        }

        .input-bar {
            display: flex;
            gap: var(--gap);
            align-items: center;
            border-top: 1px solid var(--border);
            padding-top: var(--padding);
        }

        .file-input {
            display: none;
        }

        .icon-btn {
            font-size: 18px;
            color: var(--text-gray);
            cursor: pointer;
            padding: 6px;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .icon-btn:hover {
            color: var(--primary);
            background: var(--bg-light);
        }

        .msg-input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            outline: none;
            font-size: 14px;
            resize: none;
            height: 36px;
            max-height: 100px;
            overflow-y: auto;
            background: var(--bg-light);
        }

        .msg-input:focus {
            background: var(--bg-main);
            border-color: var(--primary);
        }

        .send-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            display: none;
        }

        .call-modal.show {
            display: flex;
        }

        .call-card {
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            min-width: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .call-title {
            font-size: 15px;
            font-weight: 500;
        }

        /* 响应式适配 */
        @media (max-width: 768px) {
            .container {
                height: 100vh;
                border-radius: 0;
                border: none;
            }

            .room {
                flex-direction: column;
                align-items: stretch;
            }

            .msg {
                max-width: 85%;
            }

            .media-container {
                max-width: 160px;
            }
        }

        @media (max-width: 400px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .chat-area {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <div class="title">
                <i class="fas fa-globe"></i> 异地无服务器聊天
            </div>
            <div class="status" id="status">未初始化</div>
        </div>

        <!-- 房间配置区（异地匹配核心） -->
        <div class="room">
            <div class="input-group">
                <label class="label">专属房间号（双方必须一致）</label>
                <input type="text" class="input" id="roomCode" placeholder="输入自定义房间号，如：love666">
            </div>
            <button class="btn btn-primary" onclick="initChat()">
                <i class="fas fa-link"></i> 开始匹配
            </button>
            <button class="btn btn-success" id="callBtn" disabled onclick="startCall()">
                <i class="fas fa-phone"></i> 通话
            </button>
        </div>

        <!-- 聊天区域 -->
        <div class="chat-area">
            <div class="messages" id="messages"></div>

            <!-- 输入栏 -->
            <div class="input-bar">
                <label for="filePicker" class="icon-btn">
                    <i class="fas fa-paperclip"></i>
                </label>
                <input type="file" id="filePicker" class="file-input" accept="image/*,video/*">
                <textarea class="msg-input" id="msgInput" placeholder="回车发送，Shift+回车换行" onkeydown="if(event.keyCode===13&&!event.shiftKey){sendMessage();event.preventDefault();}"></textarea>
                <button class="btn btn-primary send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 通话弹窗 -->
    <div class="call-modal" id="callModal">
        <div class="call-card">
            <div class="call-title">正在通话中</div>
            <button class="btn btn-danger" onclick="endCall()">
                <i class="fas fa-phone-slash"></i> 挂断通话
            </button>
        </div>
    </div>

    <script>
        /**************************
         * 核心配置：公共免费信令服务（无需自己搭建）
         **************************/
        const CONFIG = {
            // 公共WebSocket信令服务器（免费、稳定、无限制）
            SIGNAL_SERVER: 'wss://echo.websocket.events', // 全球可用的公共信令转发服务
            // WebRTC配置（公共STUN服务器，用于异地网络解析）
            RTC: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun.cloudflare.com:3478' },
                    { urls: 'stun:stun.qq.com:3478' },
                    { urls: 'stun:stun.microsoft.com:3478' }
                ]
            },
            // 媒体配置（语音通话）
            MEDIA: { audio: true, video: false }
        };

        /**************************
         * 全局变量
         **************************/
        let ws = null; // 公共信令连接
        let peerConn = null; // WebRTC端对端连接
        let dataChannel = null; // 数据通道（文字/媒体）
        let localStream = null; // 本地音频流（语音通话）
        let roomCode = ''; // 房间号（异地匹配标识）
        let isConnected = false; // 是否建立端对端连接
        let isCalling = false; // 是否在通话中

        /**************************
         * 页面初始化
         **************************/
        window.onload = () => {
            updateStatus('准备就绪，输入房间号开始', 'ready');
            initFileInput(); // 初始化文件上传
        };

        /**************************
         * 1. 初始化聊天（核心：连接公共信令+创建WebRTC）
         **************************/
        function initChat() {
            roomCode = document.getElementById('roomCode').value.trim();
            if (!roomCode || roomCode.length < 2) {
                alert('请输入至少2位的房间号，双方必须一致！');
                return;
            }

            // 销毁旧连接
            if (ws) ws.close();
            if (peerConn) peerConn.close();
            if (dataChannel) dataChannel.close();

            updateStatus(`正在匹配 [${roomCode}]，等待对方...`, 'ready');
            document.getElementById('callBtn').disabled = true;
            isConnected = false;

            // 第一步：连接公共信令服务器（免费）
            connectSignalServer();
            // 第二步：初始化WebRTC端对端连接
            initRTC();
        }

        /**************************
         * 2. 连接公共信令服务器（无需自己搭建，全球可用）
         **************************/
        function connectSignalServer() {
            ws = new WebSocket(CONFIG.SIGNAL_SERVER);

            // 信令连接成功
            ws.onopen = () => {
                updateStatus(`信令已连接，等待对方加入 [${roomCode}]`, 'ready');
                // 发送房间号标识，用于异地匹配
                ws.send(JSON.stringify({ type: 'join', room: roomCode }));
            };

            // 接收信令消息（转发异地连接信息）
            ws.onmessage = async (e) => {
                try {
                    const data = JSON.parse(e.data);
                    // 仅处理相同房间号的信令
                    if (data.room !== roomCode) return;

                    // 处理WebRTC的SDP提议/应答
                    if (data.sdp) {
                        await peerConn.setRemoteDescription(new RTCSessionDescription(data.sdp));
                        // 如果是提议，回复应答
                        if (data.sdp.type === 'offer') {
                            const answer = await peerConn.createAnswer();
                            await peerConn.setLocalDescription(answer);
                            // 发送应答到公共信令
                            ws.send(JSON.stringify({
                                type: 'sdp',
                                room: roomCode,
                                sdp: peerConn.localDescription
                            }));
                        }
                    }

                    // 处理WebRTC的ICE候选（异地网络解析）
                    if (data.ice) {
                        await peerConn.addIceCandidate(new RTCIceCandidate(data.ice));
                    }
                } catch (err) {
                    console.log('信令处理失败：', err);
                }
            };

            // 信令连接关闭
            ws.onclose = () => {
                if (!isConnected) updateStatus('信令连接断开，重新匹配试试', 'error');
            };

            // 信令连接错误
            ws.onerror = (err) => {
                updateStatus('信令连接失败，换个浏览器试试', 'error');
                console.error('信令错误：', err);
            };
        }

        /**************************
         * 3. 初始化WebRTC（端对端核心，异地数据直传）
         **************************/
        function initRTC() {
            // 创建WebRTC连接
            peerConn = new RTCPeerConnection(CONFIG.RTC);

            // 创建数据通道：用于文字、图片、视频传输
            dataChannel = peerConn.createDataChannel('chatChannel', {
                ordered: true, // 保证消息顺序
                maxRetransmits: 5 // 重传次数，保证传输稳定
            });
            initDataChannel();

            // 初始化媒体通道：用于语音通话
            initMediaChannel();

            // 监听ICE候选，通过公共信令转发给对方
            peerConn.onicecandidate = (e) => {
                if (e.candidate && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'ice',
                        room: roomCode,
                        ice: e.candidate
                    }));
                }
            };

            // 监听端对端连接状态
            peerConn.onconnectionstatechange = () => {
                switch (peerConn.connectionState) {
                    case 'connected':
                        isConnected = true;
                        updateStatus(`已连接 [${roomCode}]，可以聊天/通话`, 'connected');
                        document.getElementById('callBtn').disabled = false;
                        break;
                    case 'disconnected':
                    case 'failed':
                        isConnected = false;
                        updateStatus('连接断开，重新匹配试试', 'error');
                        document.getElementById('callBtn').disabled = true;
                        if (isCalling) endCall();
                        break;
                }
            };

            // 创建连接提议，通过信令发送给对方
            peerConn.createOffer()
                .then(offer => peerConn.setLocalDescription(offer))
                .then(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'sdp',
                            room: roomCode,
                            sdp: peerConn.localDescription
                        }));
                    }
                })
                .catch(err => {
                    updateStatus('连接初始化失败', 'error');
                    console.error(err);
                });
        }

        /**************************
         * 4. 初始化数据通道（文字/图片/视频传输）
         **************************/
        function initDataChannel() {
            // 接收对方的消息/媒体
            dataChannel.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                addMessage(msg, 'other');
            };

            // 数据通道打开
            dataChannel.onopen = () => {
                isConnected = true;
                updateStatus(`已连接 [${roomCode}]，可以聊天`, 'connected');
            };

            // 数据通道关闭
            dataChannel.onclose = () => {
                if (isConnected) updateStatus('数据通道关闭', 'error');
            };
        }

        /**************************
         * 5. 初始化媒体通道（语音通话）
         **************************/
        function initMediaChannel() {
            // 接收对方的语音流
            peerConn.ontrack = (e) => {
                if (e.streams && e.streams[0]) {
                    // 无需播放，浏览器自动处理语音流
                    if (isCalling) document.getElementById('callTitle').textContent = '通话中';
                }
            };
        }

        /**************************
         * 6. 发送文字消息
         **************************/
        function sendMessage() {
            const input = document.getElementById('msgInput');
            const content = input.value.trim();
            if (!content || !isConnected || dataChannel.readyState !== 'open') {
                alert('请先建立连接，或输入有效消息！');
                return;
            }

            // 构造消息对象
            const msg = {
                type: 'text',
                content: content,
                time: getCurrentTime()
            };

            // 端对端发送
            dataChannel.send(JSON.stringify(msg));
            // 本地显示
            addMessage(msg, 'self');
            // 清空输入
            input.value = '';
        }

        /**************************
         * 7. 初始化文件上传（图片/视频）
         **************************/
        function initFileInput() {
            document.getElementById('filePicker').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file || !isConnected || dataChannel.readyState !== 'open') {
                    alert('请先建立连接再发送文件！');
                    e.target.value = '';
                    return;
                }

                // 仅支持图片/视频
                if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                    alert('仅支持图片和视频文件！');
                    e.target.value = '';
                    return;
                }

                // 读取文件并发送
                const reader = new FileReader();
                reader.onload = (e) => {
                    const msg = {
                        type: file.type.startsWith('image/') ? 'image' : 'video',
                        data: e.target.result, // Base64编码
                        name: file.name,
                        time: getCurrentTime()
                    };
                    // 端对端发送
                    dataChannel.send(JSON.stringify(msg));
                    // 本地显示
                    addMessage(msg, 'self');
                };
                reader.readAsDataURL(file);
                // 清空文件选择
                e.target.value = '';
            });
        }

        /**************************
         * 8. 开始语音通话
         **************************/
        async function startCall() {
            if (!isConnected) {
                alert('请先建立连接！');
                return;
            }

            isCalling = true;
            // 显示通话弹窗
            document.getElementById('callModal').classList.add('show');

            try {
                // 获取本地麦克风权限
                localStream = await navigator.mediaDevices.getUserMedia(CONFIG.MEDIA);
                // 将本地音频流添加到WebRTC
                localStream.getTracks().forEach(track => {
                    peerConn.addTrack(track, localStream);
                });
            } catch (err) {
                alert('获取麦克风权限失败，请允许权限后重试！');
                endCall();
                console.error(err);
            }
        }

        /**************************
         * 9. 结束语音通话
         **************************/
        function endCall() {
            isCalling = false;
            // 隐藏通话弹窗
            document.getElementById('callModal').classList.remove('show');
            // 停止本地音频流
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
        }

        /**************************
         * 10. 添加消息到聊天窗口
         **************************/
        function addMessage(msg, side) {
            const messagesEl = document.getElementById('messages');
            const msgEl = document.createElement('div');
            msgEl.className = `msg msg-${side}`;

            // 构造消息内容
            let content = '';
            if (msg.type === 'text') {
                content = `<div class="msg-content">${msg.content}</div>`;
            } else if (msg.type === 'image') {
                content = `<div class="media-container"><img src="${msg.data}" class="media-img" alt="${msg.name}"></div>`;
            } else if (msg.type === 'video') {
                content = `<div class="media-container"><video src="${msg.data}" class="media-video" controls></video></div>`;
            }

            // 拼接时间
            msgEl.innerHTML = `${content}<div class="msg-time">${msg.time}</div>`;
            messagesEl.appendChild(msgEl);
            // 滚动到底部
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        /**************************
         * 工具方法
         **************************/
        // 更新状态提示
        function updateStatus(text, cls) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.className = `status ${cls}`;
        }

        // 获取当前时间
        function getCurrentTime() {
            return new Date().toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }
    </script>
</body>
</html>

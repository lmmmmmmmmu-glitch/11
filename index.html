<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>æ‰‹æœºç‰ˆåŒ¿åèŠå¤©+é€šè¯</title>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;}
        body {background: #f5f7fa; padding: 10px; height: 100vh; display: flex; flex-direction: column;}
        .container {background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); flex: 1; display: flex; flex-direction: column;}
        .title {text-align: center; font-size: 20px; font-weight: 600; color: #333; margin-bottom: 20px;}
        .room-area {display: flex; gap: 10px; margin-bottom: 15px;}
        .room-input {flex: 1; padding: 14px 16px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 15px; outline: none;}
        .btn {padding: 14px 18px; border: none; border-radius: 12px; font-size: 15px; font-weight: 500; cursor: pointer; touch-action: manipulation;}
        .btn-create {background: #2563eb; color: #fff;}
        .btn-join {background: #10b981; color: #fff;}
        .info {display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #6b7280; margin-bottom: 15px;}
        .user-id {color: #2563eb; font-weight: 600;}
        .status {padding: 4px 8px; border-radius: 20px; font-size: 12px;}
        .status-wait {background: #fef3c7; color: #d97706;}
        .status-connected {background: #d1fae5; color: #059669;}
        .status-disconnected {background: #fee2e2; color: #dc2626;}
        .chat-box {flex: 1; border: 1px solid #e0e0e0; border-radius: 12px; padding: 15px; overflow-y: auto; margin-bottom: 15px; background: #f9fafb;}
        .msg {margin: 8px 0; padding: 10px 14px; border-radius: 10px; max-width: 75%; font-size: 14px; line-height: 1.5;}
        .msg-mine {background: #2563eb; color: #fff; margin-left: auto;}
        .msg-other {background: #e5e7eb; color: #111827; margin-right: auto;}
        .msg-time {font-size: 11px; opacity: 0.8; margin-bottom: 2px;}
        .input-area {display: flex; gap: 10px; align-items: center;}
        .msg-input {flex: 1; padding: 14px 16px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 15px; outline: none;}
        .call-btns {display: flex; gap: 8px;}
        .btn-call {background: #f59e0b; color: #fff;}
        .btn-hangup {background: #dc2626; color: #fff; display: none;}
        .tip {font-size: 12px; color: #6b7280; text-align: center; margin-top: 10px;}
        .signaling-area {margin-top: 10px; padding: 15px; border: 1px dashed #e0e0e0; border-radius: 12px; display: none;}
        .signaling-area.show {display: block;}
        .signaling-title {font-size: 13px; font-weight: 600; color: #333; margin-bottom: 8px;}
        .signaling-input {width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 12px; margin-bottom: 8px; min-height: 60px;}
        .btn-signal {padding: 8px 12px; font-size: 12px; margin-right: 5px;}
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ğŸ“ åŒ¿åèŠå¤©+é€šè¯</h1>

        <!-- æˆ¿é—´æ“ä½œåŒº -->
        <div class="room-area">
            <input type="text" class="room-input" id="roomCode" placeholder="è¾“å…¥æˆ¿é—´ç ï¼Œæˆ–ç‚¹å‡»åˆ›å»º">
            <button class="btn btn-create" onclick="createRoom()">åˆ›å»º</button>
            <button class="btn btn-join" onclick="joinRoom()">åŠ å…¥</button>
        </div>

        <!-- ä¿¡æ¯åŒº -->
        <div class="info">
            <span>ä½ çš„IDï¼š<span class="user-id" id="userId"></span></span>
            <span class="status status-disconnected" id="connStatus">æœªè¿æ¥</span>
        </div>

        <!-- èŠå¤©åŒº -->
        <div class="chat-box" id="chatBox"></div>

        <!-- è¾“å…¥æ“ä½œåŒº -->
        <div class="input-area">
            <input type="text" class="msg-input" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œå›è½¦å‘é€" onkeydown="if(event.key==='Enter')sendMsg()">
            <button class="btn btn-call" onclick="startCall()">é€šè¯</button>
            <button class="btn btn-hangup" id="hangupBtn" onclick="hangupCall()">æŒ‚æ–­</button>
        </div>

        <!-- æ‰‹åŠ¨ä¿¡ä»¤åŒºï¼ˆè¿æ¥ä¸ä¸Šæ—¶ç”¨ï¼Œæ‰‹æœºç«¯é€‚é…ï¼‰ -->
        <div class="signaling-area" id="signalingArea">
            <div class="signaling-title">ğŸ”§ æ‰‹åŠ¨è¿æ¥ï¼ˆå¤åˆ¶ä¸‹æ–¹å†…å®¹å‘ç»™å¯¹æ–¹/ç²˜è´´å¯¹æ–¹å†…å®¹ï¼‰</div>
            <input type="text" class="signaling-input" id="signalInput" placeholder="ç²˜è´´å¯¹æ–¹çš„Offer/Answer/ICE">
            <button class="btn btn-signal" onclick="addSignal()">ç¡®è®¤æ·»åŠ </button>
            <div class="tip">æ§åˆ¶å°å¯æŸ¥çœ‹éœ€å‘é€çš„å†…å®¹ï¼Œæ‰‹æœºç«¯å¯é•¿æŒ‰å¤åˆ¶</div>
        </div>

        <div class="tip">ğŸ’¡ æ‰‹æœºè¯·ç”¨Chrome/Edgeæ‰“å¼€ | å…¨ç¨‹åŒ¿å | æ— æ•°æ®å­˜å‚¨</div>
    </div>

    <script>
        // å…¨å±€å˜é‡ï¼ˆæ‰‹æœºç«¯ä¼˜åŒ–ï¼‰
        let userId = Math.random().toString(36).slice(2, 6);
        let roomCode, peerConnection, dataChannel;
        let localStream, remoteStream;
        let isInitiator = false;

        // é¡µé¢åˆå§‹åŒ–ï¼ˆæ‰‹æœºç«¯ä¼˜å…ˆï¼‰
        window.onload = () => {
            document.getElementById('userId').innerText = userId;
            updateStatus('æœªè¿æ¥', 'disconnected');
            // æ‰‹æœºç«¯ç‚¹å‡»è¾“å…¥æ¡†ä¸ç¼©æ”¾
            document.querySelector('meta[name=viewport]').content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
        };

        // âœ… æ‰‹æœºç«¯ä¼˜åŒ–ï¼šå›½å†…å¯ç”¨STUNæœåŠ¡å™¨ï¼ˆè§£å†³å¼‚åœ°ç©¿é€ï¼‰
        const RTC_CONFIG = {
            iceServers: [
                { urls: 'stun:stun.qq.com:3478' },
                { urls: 'stun:stun.aliyun.com:3478' },
                { urls: 'stun:stun.163.com:3478' }
            ]
        };

        // åª’ä½“é…ç½®ï¼ˆæ‰‹æœºéº¦å…‹é£é€‚é…ï¼‰
        const MEDIA_CONFIG = {
            audio: {
                echoCancellation: true, // æ‰‹æœºå›å£°æ¶ˆé™¤
                noiseSuppression: true, // é™å™ª
                autoGainControl: true   // è‡ªåŠ¨å¢ç›Š
            },
            video: false
        };

        // åˆ›å»ºæˆ¿é—´
        function createRoom() {
            roomCode = Math.random().toString(36).slice(2, 8).toUpperCase();
            document.getElementById('roomCode').value = roomCode;
            initPeer(true);
        }

        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            roomCode = document.getElementById('roomCode').value.trim();
            if (!roomCode) {
                alert('è¯·è¾“å…¥æˆ¿é—´ç ï¼');
                return;
            }
            initPeer(false);
        }

        // åˆå§‹åŒ–ç‚¹å¯¹ç‚¹è¿æ¥ï¼ˆæ ¸å¿ƒï¼‰
        function initPeer(initiator) {
            isInitiator = initiator;
            cleanUp(); // æ¸…ç†æ—§è¿æ¥
            showSignalingArea(); // æ˜¾ç¤ºæ‰‹åŠ¨ä¿¡ä»¤åŒºï¼ˆå…œåº•ï¼‰
            updateStatus('æ­£åœ¨è¿æ¥', 'wait');
            addSysMsg(`å¼€å§‹${initiator ? 'åˆ›å»º' : 'åŠ å…¥'}æˆ¿é—´ã€${roomCode}ã€‘`);

            // åˆ›å»ºWebRTCè¿æ¥
            peerConnection = new RTCPeerConnection(RTC_CONFIG);

            // 1. æ–‡å­—èŠå¤©æ•°æ®é€šé“
            if (initiator) {
                dataChannel = peerConnection.createDataChannel('chat', { ordered: true });
                initDataChannel();
            } else {
                peerConnection.ondatachannel = (e) => {
                    dataChannel = e.channel;
                    initDataChannel();
                };
            }

            // 2. ICEå€™é€‰è€…ï¼ˆå¼‚åœ°ç©¿é€å…³é”®ï¼‰
            peerConnection.onicecandidate = (e) => {
                if (e.candidate) {
                    console.log('ã€ICEå€™é€‰è€…ï¼Œå‘ç»™å¯¹æ–¹ã€‘', JSON.stringify(e.candidate));
                    addSysMsg('ç”Ÿæˆè¿æ¥ä¿¡æ¯ï¼Œå¯å¤åˆ¶æ§åˆ¶å°å†…å®¹å‘ç»™å¯¹æ–¹');
                }
            };

            // 3. è¯­éŸ³é€šè¯æµï¼ˆæ‰‹æœºéº¦å…‹é£é€‚é…ï¼‰
            peerConnection.ontrack = (e) => {
                remoteStream = e.streams[0];
                playAudio(remoteStream);
                addSysMsg('å¯¹æ–¹å·²æ¥å¬é€šè¯');
            };

            // 4. è¿æ¥çŠ¶æ€ï¼ˆæ‰‹æœºç«¯å®æ—¶æ›´æ–°ï¼‰
            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') {
                    updateStatus('å·²è¿æ¥', 'connected');
                    addSysMsg('âœ… è¿æ¥æˆåŠŸï¼å¯èŠå¤©/é€šè¯');
                } else if (peerConnection.connectionState === 'disconnected') {
                    updateStatus('å·²æ–­å¼€', 'disconnected');
                    addSysMsg('âŒ è¿æ¥å·²æ–­å¼€');
                }
            };

            // 5. åˆ›å»ºè€…å‘èµ·Offer
            if (initiator) {
                setTimeout(() => {
                    peerConnection.createOffer()
                        .then((offer) => peerConnection.setLocalDescription(offer))
                        .then(() => {
                            console.log('ã€Offerï¼Œå‘ç»™å¯¹æ–¹ã€‘', JSON.stringify(peerConnection.localDescription));
                            addSysMsg('ç”ŸæˆOfferï¼Œå¯å¤åˆ¶æ§åˆ¶å°å†…å®¹å‘ç»™å¯¹æ–¹');
                        });
                }, 500);
            }
        }

        // åˆå§‹åŒ–æ–‡å­—èŠå¤©é€šé“
        function initDataChannel() {
            dataChannel.onopen = () => addSysMsg('ğŸ’¬ èŠå¤©é€šé“å·²å°±ç»ª');
            dataChannel.onmessage = (e) => {
                const { sender, content } = JSON.parse(e.data);
                addMsg(sender, content, false);
            };
            dataChannel.onclose = () => addSysMsg('ğŸ’¬ èŠå¤©é€šé“å·²å…³é—­');
        }

        // å‘é€æ–‡å­—æ¶ˆæ¯ï¼ˆæ‰‹æœºç«¯å›è½¦/ç‚¹å‡»éƒ½å¯ï¼‰
        function sendMsg() {
            const content = document.getElementById('msgInput').value.trim();
            if (!content || !dataChannel || dataChannel.readyState !== 'open') {
                alert('è¯·å…ˆå»ºç«‹è¿æ¥ï¼');
                return;
            }
            // å‘é€ç»™å¯¹æ–¹
            dataChannel.send(JSON.stringify({ sender: userId, content }));
            // è‡ªå·±æ˜¾ç¤º
            addMsg('æˆ‘', content, true);
            // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆæ‰‹æœºç«¯ä¼˜åŒ–ï¼‰
            document.getElementById('msgInput').value = '';
        }

        // å‘èµ·è¯­éŸ³é€šè¯ï¼ˆæ‰‹æœºéº¦å…‹é£æƒé™é€‚é…ï¼‰
        function startCall() {
            if (!peerConnection || peerConnection.connectionState !== 'connected') {
                alert('è¯·å…ˆå»ºç«‹è¿æ¥ï¼');
                return;
            }
            // è·å–æ‰‹æœºéº¦å…‹é£æƒé™
            navigator.mediaDevices.getUserMedia(MEDIA_CONFIG)
                .then((stream) => {
                    localStream = stream;
                    // æ·»åŠ æµåˆ°è¿æ¥
                    stream.getTracks().forEach((track) => peerConnection.addTrack(track, stream));
                    // æ›´æ–°æŒ‰é’®ï¼ˆæ‰‹æœºç«¯è§¦æ‘¸å‹å¥½ï¼‰
                    document.getElementById('callBtn').style.display = 'none';
                    document.getElementById('hangupBtn').style.display = 'inline-block';
                    addSysMsg('ğŸ“ å·²å‘èµ·è¯­éŸ³é€šè¯');
                })
                .catch((err) => {
                    alert('âŒ è¯·å…è®¸éº¦å…‹é£æƒé™ï¼\næ‰‹æœºéœ€åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å¼€å¯éº¦å…‹é£');
                    console.error('éº¦å…‹é£æƒé™ï¼š', err);
                });
        }

        // æŒ‚æ–­é€šè¯ï¼ˆæ‰‹æœºç«¯ä¼˜åŒ–ï¼‰
        function hangupCall() {
            if (localStream) localStream.getTracks().forEach((t) => t.stop());
            if (remoteStream) remoteStream.getTracks().forEach((t) => t.stop());
            document.getElementById('callBtn').style.display = 'inline-block';
            document.getElementById('hangupBtn').style.display = 'none';
            addSysMsg('ğŸ“ å·²æŒ‚æ–­é€šè¯');
        }

        // æ’­æ”¾è¿œç¨‹è¯­éŸ³ï¼ˆæ‰‹æœºæ‰¬å£°å™¨é€‚é…ï¼‰
        function playAudio(stream) {
            const audio = new Audio();
            audio.srcObject = stream;
            audio.volume = 1;
            // æ‰‹æœºç«¯è‡ªåŠ¨æ’­æ”¾ï¼ˆç»•è¿‡é™åˆ¶ï¼‰
            audio.play().catch(() => {
                document.addEventListener('touchstart', () => audio.play(), { once: true });
            });
        }

        // æ‰‹åŠ¨æ·»åŠ ä¿¡ä»¤ï¼ˆ100%è§£å†³è¿æ¥é—®é¢˜ï¼Œæ‰‹æœºç«¯é•¿æŒ‰å¤åˆ¶/ç²˜è´´ï¼‰
        function addSignal() {
            const signalStr = document.getElementById('signalInput').value.trim();
            if (!signalStr) return;
            try {
                const signal = JSON.parse(signalStr);
                // è¯†åˆ«æ˜¯Offer/Answer/ICE
                if (signal.type === 'offer' || signal.type === 'answer') {
                    peerConnection.setRemoteDescription(new RTCSessionDescription(signal))
                        .then(() => {
                            if (signal.type === 'offer') {
                                // æ”¶åˆ°Offerï¼Œç”ŸæˆAnswer
                                peerConnection.createAnswer()
                                    .then((answer) => peerConnection.setLocalDescription(answer))
                                    .then(() => {
                                        console.log('ã€Answerï¼Œå‘ç»™å¯¹æ–¹ã€‘', JSON.stringify(peerConnection.localDescription));
                                        addSysMsg('ç”ŸæˆAnswerï¼Œå·²å‘ç»™å¯¹æ–¹');
                                    });
                            }
                        });
                } else if (signal.candidate) {
                    // æ·»åŠ å·¥Eå€™é€‰è€…
                    peerConnection.addIceCandidate(new RTCIceCandidate(signal));
                    addSysMsg('âœ… å·²æ·»åŠ å¯¹æ–¹è¿æ¥ä¿¡æ¯');
                }
                document.getElementById('signalInput').value = '';
            } catch (err) {
                alert('å†…å®¹æ ¼å¼é”™è¯¯ï¼è¯·å¤åˆ¶å®Œæ•´çš„æ§åˆ¶å°å†…å®¹');
            }
        }

        // è¾…åŠ©æ–¹æ³•ï¼šæ·»åŠ æ¶ˆæ¯
        function addMsg(sender, content, isMine) {
            const chatBox = document.getElementById('chatBox');
            const time = new Date().toLocaleTimeString();
            const cls = isMine ? 'msg-mine' : 'msg-other';
            const msg = `
                <div class="msg ${cls}">
                    <div class="msg-time">${sender} Â· ${time}</div>
                    <div>${content}</div>
                </div>
            `;
            chatBox.innerHTML += msg;
            // æ‰‹æœºç«¯æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆå¹³æ»‘ï¼‰
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSysMsg(content) {
            addMsg('ç³»ç»Ÿ', content, false);
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateStatus(text, type) {
            const el = document.getElementById('connStatus');
            el.innerText = text;
            el.className = `status status-${type}`;
        }

        // æ˜¾ç¤ºæ‰‹åŠ¨ä¿¡ä»¤åŒº
        function showSignalingArea() {
            document.getElementById('signalingArea').className = 'signaling-area show';
        }

        // æ¸…ç†èµ„æºï¼ˆæ‰‹æœºç«¯é˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
        function cleanUp() {
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach((t) => t.stop());
            if (remoteStream) remoteStream.getTracks().forEach((t) => t.stop());
            document.getElementById('callBtn').style.display = 'inline-block';
            document.getElementById('hangupBtn').style.display = 'none';
        }

        // æ‰‹æœºç«¯é¡µé¢å…³é—­æ—¶æ¸…ç†
        window.onbeforeunload = cleanUp;
    </script>
</body>
</html>

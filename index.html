<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>稳定版异地无服务器聊天</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #fff;
            --bg-light: #f7f8fa;
            --text: #333;
            --text-gray: #999;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #16a34a;
            --danger: #dc2626;
            --border: #eaeaea;
            --radius: 8px;
            --gap: 10px;
            --pad: 12px;
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }

        body {
            background: #f2f3f5;
            min-height: 100vh;
            padding: 8px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: var(--pad);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 17px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--bg-light);
        }

        .status.ready { color: var(--primary); background: rgba(37, 99, 235, 0.1); }
        .status.connected { color: var(--success); background: rgba(22, 163, 74, 0.1); }
        .status.reconnecting { color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .status.error { color: var(--danger); background: rgba(220, 38, 38, 0.1); }

        .room {
            padding: var(--pad);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: var(--gap);
            align-items: center;
        }

        .input-box {
            flex: 1;
            min-width: 190px;
        }

        .label {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 4px;
            display: block;
        }

        .input {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            outline: none;
            font-size: 14px;
            transition: var(--transition);
        }

        .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 9px 15px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-success {
            background: var(--success);
            color: #fff;
        }

        .btn-success:disabled {
            background: var(--text-gray);
            cursor: not-allowed;
        }

        .chat {
            flex: 1;
            padding: var(--pad);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: var(--gap);
        }

        .messages::-webkit-scrollbar {
            width: 4px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        .msg {
            max-width: 80%;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .msg-self {
            align-self: flex-end;
        }

        .msg-other {
            align-self: flex-start;
        }

        .msg-content {
            padding: 10px 14px;
            border-radius: var(--radius);
            font-size: 14px;
            line-height: 1.5;
        }

        .msg-self .msg-content {
            background: var(--primary);
            color: #fff;
            border-bottom-right-radius: 3px;
        }

        .msg-other .msg-content {
            background: var(--bg-light);
            border-bottom-left-radius: 3px;
        }

        .msg-time {
            font-size: 11px;
            color: var(--text-gray);
            align-self: flex-end;
        }

        .msg-other .msg-time {
            align-self: flex-start;
        }

        .media {
            max-width: 220px;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .media-img, .media-video {
            width: 100%;
            height: auto;
            display: block;
        }

        .media-video {
            max-height: 300px;
            object-fit: cover;
        }

        .input-area {
            display: flex;
            gap: var(--gap);
            align-items: center;
            border-top: 1px solid var(--border);
            padding-top: var(--pad);
        }

        .file-input {
            display: none;
        }

        .icon {
            font-size: 19px;
            color: var(--text-gray);
            cursor: pointer;
            padding: 7px;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .icon:hover {
            color: var(--primary);
            background: var(--bg-light);
        }

        .msg-input {
            flex: 1;
            padding: 9px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            outline: none;
            font-size: 14px;
            resize: none;
            height: 38px;
            max-height: 120px;
            overflow-y: auto;
            background: var(--bg-light);
        }

        .msg-input:focus {
            background: var(--bg-main);
            border-color: var(--primary);
        }

        .send-btn {
            width: 38px;
            height: 38px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            display: none;
        }

        .call-modal.show {
            display: flex;
        }

        .call-card {
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 22px;
            min-width: 260px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
        }

        .call-title {
            font-size: 16px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .container {
                height: 100vh;
                border-radius: 0;
                border: none;
            }

            .room {
                flex-direction: column;
                align-items: stretch;
            }

            .msg {
                max-width: 88%;
            }

            .media {
                max-width: 180px;
            }
        }

        @media (max-width: 420px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .chat {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">
                <i class="fas fa-comments"></i> 稳定版异地聊天
            </div>
            <div class="status" id="status">准备就绪</div>
        </div>

        <div class="room">
            <div class="input-box">
                <label class="label">专属房间号（双方必须一致）</label>
                <input type="text" class="input" id="roomCode" placeholder="如：8888、mychat">
            </div>
            <button class="btn btn-primary" onclick="startChat()">
                <i class="fas fa-plug"></i> 开始连接
            </button>
            <button class="btn btn-success" id="callBtn" disabled onclick="startCall()">
                <i class="fas fa-phone"></i> 通话
            </button>
        </div>

        <div class="chat">
            <div class="messages" id="messages"></div>

            <div class="input-area">
                <label for="fileInput" class="icon">
                    <i class="fas fa-paperclip"></i>
                </label>
                <input type="file" id="fileInput" class="file-input" accept="image/*,video/*">
                <textarea class="msg-input" id="msgInput" placeholder="回车发送，Shift+回车换行" onkeydown="if(event.keyCode===13&&!event.shiftKey){sendMsg();event.preventDefault();}"></textarea>
                <button class="btn btn-primary send-btn" onclick="sendMsg()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="call-modal" id="callModal">
        <div class="call-card">
            <div class="call-title" id="callTitle">正在通话</div>
            <button class="btn btn-danger" onclick="endCall()">
                <i class="fas fa-phone-slash"></i> 挂断
            </button>
        </div>
    </div>

    <script>
        /**************************
         * 核心优化：多备用公共信令服务器（解决断开问题）
         **************************/
        const CONFIG = {
            // 备用信令服务器列表（按优先级排序，自动切换）
            SIGNAL_SERVERS: [
                'wss://ws.postman-echo.com/raw', // 稳定级公共服务
                'wss://echo.websocket.org',      // 经典公共回声服务
                'wss://ws.ifelse.io',            // 轻量公共服务
                'wss://echo.websocket.events'    // 兜底服务
            ],
            RTC: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun.cloudflare.com:3478' },
                    { urls: 'stun:stun.aliyun.com:3478' },
                    { urls: 'stun:stun.qq.com:3478' }
                ]
            },
            MEDIA: { audio: true, video: false },
            RECONNECT_INTERVAL: 3000, // 断线重连间隔（3秒）
            CURRENT_SERVER_INDEX: 0   // 当前使用的信令服务器索引
        };

        /**************************
         * 全局变量
         **************************/
        let ws = null;
        let peerConn = null;
        let dataChannel = null;
        let localStream = null;
        let roomCode = '';
        let isConnected = false;
        let isCalling = false;
        let reconnectTimer = null; // 重连定时器

        /**************************
         * 页面初始化
         **************************/
        window.onload = () => {
            updateStatus('准备就绪，输入房间号开始', 'ready');
            initFileInput();
            // 页面关闭时清理连接
            window.onbeforeunload = () => {
                clearTimeout(reconnectTimer);
                closeAllConnections();
            };
        };

        /**************************
         * 1. 核心：开始连接（自动切换信令服务器）
         **************************/
        function startChat() {
            roomCode = document.getElementById('roomCode').value.trim();
            if (!roomCode || roomCode.length < 2) {
                alert('请输入至少2位的房间号，双方必须完全一致！');
                return;
            }

            // 清理旧连接
            closeAllConnections();
            clearTimeout(reconnectTimer);

            updateStatus(`正在连接 [${roomCode}]，请稍候...`, 'ready');
            document.getElementById('callBtn').disabled = true;
            isConnected = false;

            // 开始连接（从第一个信令服务器开始）
            CONFIG.CURRENT_SERVER_INDEX = 0;
            connectSignalServer();
        }

        /**************************
         * 2. 连接信令服务器（自动切换备用）
         **************************/
        function connectSignalServer() {
            // 超出备用列表，停止重连
            if (CONFIG.CURRENT_SERVER_INDEX >= CONFIG.SIGNAL_SERVERS.length) {
                updateStatus('所有信令服务器都无法连接，请稍后再试', 'error');
                return;
            }

            const currentServer = CONFIG.SIGNAL_SERVERS[CONFIG.CURRENT_SERVER_INDEX];
            updateStatus(`正在连接信令服务器 [${CONFIG.CURRENT_SERVER_INDEX + 1}/${CONFIG.SIGNAL_SERVERS.length}]`, 'ready');

            ws = new WebSocket(currentServer);

            // 连接成功
            ws.onopen = () => {
                clearTimeout(reconnectTimer);
                updateStatus(`信令已连接，等待对方加入 [${roomCode}]`, 'ready');
                // 发送房间标识
                ws.send(JSON.stringify({ type: 'join', room: roomCode, ts: new Date().getTime() }));
                // 初始化WebRTC
                initRTC();
            };

            // 接收信令消息
            ws.onmessage = async (e) => {
                try {
                    // 过滤空消息/非JSON消息
                    if (!e.data || e.data === 'pong') return;
                    const data = JSON.parse(e.data);
                    if (!data || data.room !== roomCode) return;

                    // 处理SDP/ICE
                    if (data.sdp) {
                        await peerConn.setRemoteDescription(new RTCSessionDescription(data.sdp));
                        if (data.sdp.type === 'offer') {
                            const answer = await peerConn.createAnswer();
                            await peerConn.setLocalDescription(answer);
                            sendSignal({ type: 'sdp', room: roomCode, sdp: peerConn.localDescription });
                        }
                    }
                    if (data.ice) {
                        await peerConn.addIceCandidate(new RTCIceCandidate(data.ice));
                    }
                } catch (err) {
                    console.log('信令处理异常：', err);
                }
            };

            // 连接关闭：自动切换下一个服务器
            ws.onclose = () => {
                if (isConnected) {
                    updateStatus('信令断开，正在自动重连...', 'reconnecting');
                }
                // 清理旧RTC
                if (peerConn) peerConn.close();
                // 延迟重连
                reconnectTimer = setTimeout(() => {
                    CONFIG.CURRENT_SERVER_INDEX++;
                    connectSignalServer();
                }, CONFIG.RECONNECT_INTERVAL);
            };

            // 连接错误：直接切换下一个
            ws.onerror = () => {
                ws.close();
                CONFIG.CURRENT_SERVER_INDEX++;
                setTimeout(connectSignalServer, 1000);
            };
        }

        /**************************
         * 3. 初始化WebRTC端对端连接
         **************************/
        function initRTC() {
            peerConn = new RTCPeerConnection(CONFIG.RTC);

            // 创建数据通道
            dataChannel = peerConn.createDataChannel('chat', { ordered: true, maxRetransmits: 10 });
            dataChannel.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                addMsg(msg, 'other');
            };
            dataChannel.onopen = () => {
                isConnected = true;
                updateStatus(`已成功连接 [${roomCode}]，可聊天/通话`, 'connected');
                document.getElementById('callBtn').disabled = false;
            };
            dataChannel.onclose = () => {
                if (isConnected) {
                    isConnected = false;
                    updateStatus('数据通道断开，正在重连...', 'reconnecting');
                }
            };

            // 媒体通道
            peerConn.ontrack = (e) => {
                if (isCalling) document.getElementById('callTitle').textContent = '通话中';
            };

            // ICE候选转发
            peerConn.onicecandidate = (e) => {
                if (e.candidate && ws && ws.readyState === WebSocket.OPEN) {
                    sendSignal({ type: 'ice', room: roomCode, ice: e.candidate });
                }
            };

            // 连接状态
            peerConn.onconnectionstatechange = () => {
                if (peerConn.connectionState === 'disconnected' || peerConn.connectionState === 'failed') {
                    isConnected = false;
                    document.getElementById('callBtn').disabled = true;
                    if (isCalling) endCall();
                    updateStatus('连接断开，正在自动重连...', 'reconnecting');
                }
            };

            // 创建Offer
            peerConn.createOffer()
                .then(offer => peerConn.setLocalDescription(offer))
                .then(() => {
                    sendSignal({ type: 'sdp', room: roomCode, sdp: peerConn.localDescription });
                })
                .catch(err => {
                    console.error('RTC初始化失败：', err);
                });
        }

        /**************************
         * 4. 发送信令消息
         **************************/
        function sendSignal(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            }
        }

        /**************************
         * 5. 发送文字消息
         **************************/
        function sendMsg() {
            const input = document.getElementById('msgInput');
            const content = input.value.trim();
            if (!content || !isConnected || dataChannel.readyState !== 'open') {
                alert('请先建立稳定连接，或输入有效消息！');
                return;
            }

            const msg = {
                type: 'text',
                content: content,
                time: getTime()
            };

            dataChannel.send(JSON.stringify(msg));
            addMsg(msg, 'self');
            input.value = '';
        }

        /**************************
         * 6. 文件上传（图片/视频）
         **************************/
        function initFileInput() {
            document.getElementById('fileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file || !isConnected || dataChannel.readyState !== 'open') {
                    alert('请先建立稳定连接再发送文件！');
                    e.target.value = '';
                    return;
                }

                if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                    alert('仅支持图片/视频文件！');
                    e.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const msg = {
                        type: file.type.startsWith('image/') ? 'image' : 'video',
                        data: e.target.result,
                        name: file.name,
                        time: getTime()
                    };
                    dataChannel.send(JSON.stringify(msg));
                    addMsg(msg, 'self');
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            });
        }

        /**************************
         * 7. 语音通话
         **************************/
        async function startCall() {
            if (!isConnected) {
                alert('请先建立连接！');
                return;
            }

            isCalling = true;
            document.getElementById('callModal').classList.add('show');

            try {
                localStream = await navigator.mediaDevices.getUserMedia(CONFIG.MEDIA);
                localStream.getTracks().forEach(track => {
                    peerConn.addTrack(track, localStream);
                });
            } catch (err) {
                alert('麦克风权限被拒绝，请允许后重试！');
                endCall();
            }
        }

        /**************************
         * 8. 结束通话
         **************************/
        function endCall() {
            isCalling = false;
            document.getElementById('callModal').classList.remove('show');
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
        }

        /**************************
         * 9. 添加消息到页面
         **************************/
        function addMsg(msg, side) {
            const msgBox = document.getElementById('messages');
            const msgEl = document.createElement('div');
            msgEl.className = `msg msg-${side}`;

            let content = '';
            if (msg.type === 'text') {
                content = `<div class="msg-content">${msg.content}</div>`;
            } else if (msg.type === 'image') {
                content = `<div class="media"><img src="${msg.data}" class="media-img" alt="${msg.name}"></div>`;
            } else if (msg.type === 'video') {
                content = `<div class="media"><video src="${msg.data}" class="media-video" controls></video></div>`;
            }

            msgEl.innerHTML = `${content}<div class="msg-time">${msg.time}</div>`;
            msgBox.appendChild(msgEl);
            msgBox.scrollTop = msgBox.scrollHeight;
        }

        /**************************
         * 工具方法
         **************************/
        // 更新状态
        function updateStatus(text, cls) {
            const el = document.getElementById('status');
            el.textContent = text;
            el.className = `status ${cls}`;
        }

        // 获取时间
        function getTime() {
            return new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        // 关闭所有连接
        function closeAllConnections() {
            if (ws) ws.close();
            if (peerConn) peerConn.close();
            if (dataChannel) dataChannel.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QQæ”¶è—å½“æœåŠ¡å™¨ | å¼‚åœ°èŠå¤©ï¼ˆå·²é€‚é…ä½ çš„é“¾æ¥ï¼‰</title>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif;}
        body {padding: 15px; background: #f5f5f5;}
        .container {max-width: 500px; margin: 0 auto; background: #fff; border-radius: 20px; padding: 25px; box-shadow: 0 0 20px rgba(0,0,0,0.05);}
        .title {text-align: center; font-size: 19px; font-weight: 600; color: #333; margin-bottom: 25px;}
        .input-box {margin: 15px 0;}
        .label {font-size: 14px; color: #666; margin-bottom: 8px; display: block;}
        .input {width: 100%; padding: 14px; border: 1px solid #e0e0e0; border-radius: 12px; outline: none; font-size: 14px;}
        .btn {width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: 500; cursor: pointer; margin: 10px 0; color: #fff;}
        .btn-init {background: #2563eb;}
        .btn-send {background: #10b981;}
        .btn-clear {background: #f59e0b;}
        .chat-box {height: 300px; border: 1px solid #e0e0e0; border-radius: 12px; padding: 15px; overflow-y: auto; margin: 20px 0;}
        .msg {margin: 10px 0; padding: 12px 16px; border-radius: 10px; max-width: 75%; font-size: 14px; line-height: 1.5;}
        .my {background: #2563eb; color: #fff; margin-left: auto;}
        .other {background: #e5e7eb; color: #111827; margin-right: auto;}
        .msg-time {font-size: 11px; opacity: 0.8; margin-bottom: 3px;}
        .tip {font-size: 12px; color: #666; margin-top: 10px; line-height: 1.5;}
        .highlight {color: #2563eb; font-weight: 600;}
        .link-box {background: #f9fafb; padding: 12px; border-radius: 8px; font-size: 13px; color: #333; margin: 10px 0; word-break: break-all;}
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ğŸ“± QQæ”¶è—ï½œå¼‚åœ°èŠå¤©</h1>

        <!-- å·²é›†æˆä½ çš„QQæ”¶è—é“¾æ¥ -->
        <div class="input-box">
            <label class="label">ğŸ“Œ å·²ç»‘å®šä½ çš„QQæ”¶è—é“¾æ¥</label>
            <div class="link-box">https://sharechain.qq.com/8dab4acfec14b9eeb196ddd7184e55de?qq_aio_chat_type=2</div>
            <button class="btn btn-init" onclick="initChat()">ç‚¹å‡»åˆå§‹åŒ–è¿æ¥ï¼ˆæ— éœ€æ‰‹åŠ¨ç²˜è´´ï¼‰</button>
        </div>

        <!-- ç¬¬äºŒæ­¥ï¼šä¿¡ä»¤äº¤æ¢åŒºï¼ˆæ ¸å¿ƒï¼‰ -->
        <div class="input-box">
            <label class="label">ğŸ”§ ç¬¬äºŒæ­¥ï¼šä¿¡ä»¤äº¤æ¢ï¼ˆå¤åˆ¶/ç²˜è´´ï¼‰</label>
            <input type="text" class="input" id="signalInput" placeholder="å‘èµ·æ–¹ï¼šç”Ÿæˆåç²˜è´´åˆ°QQæ”¶è— | æ¥æ”¶æ–¹ï¼šç²˜è´´QQæ”¶è—é‡Œçš„ä¿¡ä»¤">
            <button class="btn btn-send" onclick="exchangeSignal()">ç¡®è®¤äº¤æ¢ä¿¡ä»¤</button>
        </div>

        <!-- èŠå¤©åŒº -->
        <div class="chat-box" id="chatBox"></div>

        <!-- æ¶ˆæ¯è¾“å…¥åŒº -->
        <div class="input-box">
            <input type="text" class="input" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œå›è½¦å‘é€">
            <button class="btn btn-clear" onclick="clearChat()">æ¸…ç©ºèŠå¤©</button>
        </div>

        <!-- æ“ä½œæç¤º -->
        <div class="tip">
            <p>ğŸ’¡ æ“ä½œæ­¥éª¤ï¼ˆå·²é€‚é…ä½ çš„é“¾æ¥ï¼Œç®€åŒ–ç‰ˆï¼‰ï¼š</p>
            <p>1. ç‚¹å‡»ã€Œåˆå§‹åŒ–è¿æ¥ã€ï¼Œé€‰æ‹©ä½ æ˜¯ã€å‘èµ·æ–¹ã€‘è¿˜æ˜¯ã€æ¥æ”¶æ–¹ã€‘ï¼›</p>
            <p>2. å‘èµ·æ–¹ï¼šå¤åˆ¶ç”Ÿæˆçš„ä¿¡ä»¤ï¼Œ<a class="highlight">ç²˜è´´åˆ°ä½ çš„QQæ”¶è—ç¬”è®°</a>ï¼›</p>
            <p>3. æ¥æ”¶æ–¹ï¼šä»ä½ çš„QQæ”¶è—å¤åˆ¶ä¿¡ä»¤ï¼Œç²˜è´´åˆ°è¾“å…¥æ¡†ç‚¹å‡»ã€Œç¡®è®¤äº¤æ¢ã€ï¼›</p>
            <p>4. è¿æ¥æˆåŠŸåï¼Œç›´æ¥èŠå¤©ï¼Œæ•°æ®ç‚¹å¯¹ç‚¹ä¼ è¾“ï¼</p>
        </div>
    </div>

    <script>
        // å·²é›†æˆä½ çš„QQæ”¶è—é“¾æ¥ï¼ˆæ— éœ€æ‰‹åŠ¨è¾“å…¥ï¼‰
        const QQ_COLLECTION_LINK = 'https://sharechain.qq.com/8dab4acfec14b9eeb196ddd7184e55de?qq_aio_chat_type=2';
        let userId = Math.random().toString(36).slice(2, 7);
        let peerConnection, dataChannel, isInitiator = false;

        // å›½å†…STUNæœåŠ¡å™¨ï¼ˆä¿è¯å¼‚åœ°ç©¿é€ï¼‰
        const RTC_CONFIG = {
            iceServers: [
                { urls: 'stun:stun.qq.com:3478' },
                { urls: 'stun:stun.aliyun.com:3478' },
                { urls: 'stun:stun.163.com:3478' }
            ]
        };

        // ========== æ ¸å¿ƒï¼šåˆå§‹åŒ–èŠå¤© ==========
        function initChat() {
            // è¯¢é—®èº«ä»½ï¼šå‘èµ·æ–¹/æ¥æ”¶æ–¹
            const role = confirm('ä½ æ˜¯ã€å‘èµ·æ–¹ã€‘è¿˜æ˜¯ã€æ¥æ”¶æ–¹ã€‘ï¼Ÿ\nç‚¹å‡»ã€Œç¡®å®šã€= å‘èµ·æ–¹ | ç‚¹å‡»ã€Œå–æ¶ˆã€= æ¥æ”¶æ–¹');
            isInitiator = role;

            // æ¸…ç†æ—§è¿æ¥
            cleanUp();
            // åˆ›å»ºWebRTCè¿æ¥
            createPeerConnection();
            // å‘èµ·æ–¹ç”Ÿæˆä¿¡ä»¤
            if (isInitiator) {
                addSysMsg('âœ… ä½ æ˜¯å‘èµ·æ–¹ï¼Œè¯·å°†ä¸‹æ–¹ä¿¡ä»¤ç²˜è´´åˆ°ä½ çš„QQæ”¶è—ç¬”è®°ï¼');
                peerConnection.onicecandidate = (e) => {
                    if (e.candidate) {
                        const signal = JSON.stringify(e.candidate);
                        document.getElementById('signalInput').value = signal;
                        addSysMsg('ğŸ“‹ ä¿¡ä»¤å·²ç”Ÿæˆï¼Œå¤åˆ¶åˆ°QQæ”¶è—å³å¯ï¼');
                    }
                };
            } else {
                addSysMsg('âœ… ä½ æ˜¯æ¥æ”¶æ–¹ï¼Œè¯·ä»ä½ çš„QQæ”¶è—å¤åˆ¶ä¿¡ä»¤ï¼Œç²˜è´´åˆ°è¾“å…¥æ¡†åç‚¹å‡»ã€Œç¡®è®¤äº¤æ¢ã€ï¼');
            }
        }

        // ========== æ ¸å¿ƒï¼šåˆ›å»ºç‚¹å¯¹ç‚¹è¿æ¥ ==========
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(RTC_CONFIG);

            // æ–‡å­—èŠå¤©æ•°æ®é€šé“
            if (isInitiator) {
                dataChannel = peerConnection.createDataChannel('chat', { ordered: true });
                initDataChannel();
                // å‘èµ·æ–¹åˆ›å»ºOffer
                setTimeout(() => {
                    peerConnection.createOffer()
                        .then(offer => peerConnection.setLocalDescription(offer))
                        .then(() => {
                            const offerSignal = JSON.stringify(peerConnection.localDescription);
                            document.getElementById('signalInput').value = offerSignal;
                        });
                }, 500);
            } else {
                peerConnection.ondatachannel = (e) => {
                    dataChannel = e.channel;
                    initDataChannel();
                };
            }

            // è¿æ¥çŠ¶æ€å›è°ƒ
            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') {
                    addSysMsg('ğŸ‰ å¼‚åœ°è¿æ¥æˆåŠŸï¼å¼€å§‹èŠå¤©å§ï¼ˆæ•°æ®ç‚¹å¯¹ç‚¹ä¼ è¾“ï¼Œä¸ç»è¿‡QQï¼‰');
                } else if (peerConnection.connectionState === 'disconnected') {
                    addSysMsg('âŒ è¿æ¥å·²æ–­å¼€ï¼Œè¯·é‡æ–°åˆå§‹åŒ–');
                }
            };
        }

        // ========== æ ¸å¿ƒï¼šäº¤æ¢ä¿¡ä»¤ ==========
        function exchangeSignal() {
            const signalStr = document.getElementById('signalInput').value.trim();
            if (!signalStr || !peerConnection) {
                alert('è¯·å…ˆåˆå§‹åŒ–è¿æ¥ï¼Œå¹¶è¾“å…¥æœ‰æ•ˆçš„ä¿¡ä»¤ï¼');
                return;
            }

            try {
                const signal = JSON.parse(signalStr);
                if (signal.type === 'offer' || signal.type === 'answer') {
                    peerConnection.setRemoteDescription(new RTCSessionDescription(signal))
                        .then(() => {
                            if (signal.type === 'offer') {
                                peerConnection.createAnswer()
                                    .then(answer => peerConnection.setLocalDescription(answer))
                                    .then(() => {
                                        const answerSignal = JSON.stringify(peerConnection.localDescription);
                                        document.getElementById('signalInput').value = answerSignal;
                                        addSysMsg('ğŸ“‹ Answerå·²ç”Ÿæˆï¼Œå¯å‘é€ç»™å‘èµ·æ–¹ï¼');
                                    });
                            }
                        });
                } else if (signal.candidate) {
                    peerConnection.addIceCandidate(new RTCIceCandidate(signal));
                    addSysMsg('âœ… ä¿¡ä»¤äº¤æ¢æˆåŠŸï¼Œæ­£åœ¨å»ºç«‹è¿æ¥...');
                }
            } catch (err) {
                alert('ä¿¡ä»¤æ ¼å¼é”™è¯¯ï¼è¯·å¤åˆ¶å®Œæ•´çš„QQæ”¶è—å†…å®¹');
            }
        }

        // ========== èŠå¤©åŠŸèƒ½ ==========
        function initDataChannel() {
            dataChannel.onopen = () => addSysMsg('ğŸ’¬ èŠå¤©é€šé“å·²å°±ç»ª');
            dataChannel.onmessage = (e) => {
                const { id, msg, time } = JSON.parse(e.data);
                addMsg(id, msg, time, false);
            };
            dataChannel.onclose = () => addSysMsg('ğŸ’¬ èŠå¤©é€šé“å·²å…³é—­');
        }

        function sendMsg() {
            const content = document.getElementById('msgInput').value.trim();
            if (!content || !dataChannel || dataChannel.readyState !== 'open') {
                alert('è¯·å…ˆå»ºç«‹è¿æ¥ï¼');
                return;
            }

            const time = new Date().toLocaleTimeString();
            dataChannel.send(JSON.stringify({ id: userId, msg: content, time: time }));
            addMsg('æˆ‘', content, time, true);
            document.getElementById('msgInput').value = '';
        }

        document.getElementById('msgInput').onkeydown = (e) => {
            if (e.key === 'Enter') sendMsg();
        };

        function addMsg(sender, content, time, isMine) {
            const chatBox = document.getElementById('chatBox');
            const cls = isMine ? 'msg my' : 'msg other';
            const msgHtml = `
                <div class="${cls}">
                    <div class="msg-time">${sender} Â· ${time}</div>
                    <div>${content}</div>
                </div>
            `;
            chatBox.innerHTML += msgHtml;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSysMsg(content) {
            const time = new Date().toLocaleTimeString();
            addMsg('ç³»ç»Ÿ', content, time, false);
        }

        function clearChat() {
            document.getElementById('chatBox').innerHTML = '';
        }

        // ========== è¾…åŠ©æ–¹æ³• ==========
        function cleanUp() {
            if (peerConnection) peerConnection.close();
            if (dataChannel) dataChannel.close();
            document.getElementById('signalInput').value = '';
        }

        window.onbeforeunload = cleanUp;
    </script>
</body>
</html>
